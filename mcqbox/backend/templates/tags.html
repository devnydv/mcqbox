{% extends "base.html" %}
{% block title %}Dashboard - MCQ Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i data-feather="tag" class="me-2"></i>Tags</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTagModal">
                <i data-feather="plus" class="me-2"></i>Add Tag
            </button>
        </div>
    </div>
</div>

<!-- # tags filter -->
<div class="row mb-3">
    <div class="col-12">
        <form method="GET" id="filterForm">
            <div class="row">
                <div class="col-md-3">
                    <select name="category_id" class="form-select" id="categorySelect" onchange="updateSubcategories()">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if category.id==selected_category %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select name="subcategory_id" class="form-select" id="subcategorySelect"
                        onchange="this.form.submit()">
                        <option value="">All Subcategories</option>
                        {% for subcategory in subcategories %}
                        <option value="{{ subcategory.id }}" {% if subcategory.id==selected_subcategory %}selected{%
                            endif %}>
                            {{ subcategory.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

            </div>
        </form>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if tags %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Subcategory</th>
                                <th>Created</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tag in tags %}
                            <tr>
                                <td>
                                    <strong>{{ tag.name }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">
                                        {{ tag.category.name if tag.category.name else 'Unknown' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="text-muted">
                                        {{ tag.subcategory.name if tag.subcategory else 'Unknown' }}
                                    </span>
                                </td>
                                <td>
                                    <small class="text-muted">{{ tag.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                </td>
                                <td class="text-end">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-secondary"
                                            onclick="editTag('{{ tag.id }}', '{{ tag.name }}', {{ tag.category_id }}, {{ tag.subcategory_id }})"
                                            data-bs-toggle="modal" data-bs-target="#editTagModal">
                                            <i data-feather="edit-2"></i>
                                        </button>
                                        <a href="{{ url_for('questions', tag_id=tag.id) }}"
                                            class="btn btn-sm btn-outline-primary">
                                            <i data-feather="help-circle"></i>
                                        </a>
                                        <form method="POST" action="{{ url_for('delete_tag', tag_id=tag.id) }}"
                                            class="d-inline"
                                            onsubmit="return confirm('Are you sure? This will delete all questions in this subcategory.')">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i data-feather="trash-2"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i data-feather="folder-plus" class="mb-3" style="width: 3rem; height: 3rem;"></i>
                    <h4>No Tags Yet</h4>
                    {% if selected_category %}
                    <p class="text-muted">No sub subcategories found in <strong>{{ selected_category.name }}</strong>
                        category.</p>
                    {% else %}
                    <p class="text-muted">Create your first subcategory to organize your MCQ questions.</p>
                    {% endif %}
                    {% if categories %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createSubcategoryModal">
                        <i data-feather="plus" class="me-2"></i>Create Tags
                    </button>
                    {% else %}
                    <p class="text-muted">You need to create at least one category first.</p>
                    <a href="{{ url_for('categories') }}" class="btn btn-primary">
                        <i data-feather="folder" class="me-2"></i>Create Category
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<!-- Create tag Modal -->
<div class="modal fade" id="createTagModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('create_tag') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Tag</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="createCategoryId" class="form-label">Category *</label>
                        <select class="form-select" id="createCategoryId" name="category_id"
                            onchange="updateCreateSubcategories()" required>
                            <option value="">Select a category</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="createSubcategoryId" class="form-label">Subcategory *</label>
                        <select class="form-select" id="createSubcategoryId" name="subcategory_id" required>
                            <option value="">Select a subcategory</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="name" class="form-label">Tag Name *</label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Tag</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- edit tag -->
<!-- Edit Tag Modal -->
<div class="modal fade" id="editTagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="editTagForm">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Tag</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editCategoryId" class="form-label">Category *</label>
                        <select class="form-select" id="editCategoryId" name="category_id"
                            onchange="updateEditSubcategories(this.value)" required>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSubcategoryId" class="form-label">Subcategory *</label>
                        <select class="form-select" id="editSubcategoryId" name="subcategory_id" required>
                            {% for subcategory in subcategories %}
                            <option value="{{ subcategory.id }}">{{ subcategory.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editName" class="form-label">Tag Name *</label>
                        <input type="text" class="form-control" id="editName" name="name" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Tag</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    function updateSubcategories() {
        const categoryId = document.getElementById('categorySelect').value;
        const subcategorySelect = document.getElementById('subcategorySelect');
        const form = document.getElementById('filterForm'); // FIX: define form

        subcategorySelect.innerHTML = '<option value="">All Subcategories</option>';

        if (categoryId) {
            fetch('/api/subcategories/' + categoryId)
                .then(response => response.json())
                .then(data => {
                    data.forEach(subcategory => {
                        const option = document.createElement('option');
                        option.value = subcategory.id;
                        option.textContent = subcategory.name;
                        subcategorySelect.appendChild(option);
                    });
                    form.submit(); // auto-submit filter form
                })
                .catch(error => {
                    console.error('Error loading subcategories:', error);
                    form.submit();
                });
        } else {
            form.submit();
        }
    }

    function updateCreateSubcategories() {
        const categoryId = document.getElementById('createCategoryId').value;
        const subcategorySelect = document.getElementById('createSubcategoryId');

        subcategorySelect.innerHTML = '<option value="">Select a subcategory</option>';

        if (categoryId) {
            fetch('/api/subcategories/' + categoryId)
                .then(response => response.json())
                .then(data => {
                    data.forEach(subcategory => {
                        const option = document.createElement('option');
                        option.value = subcategory.id;
                        option.textContent = subcategory.name;
                        subcategorySelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading create-subcategories:', error));
        }
    }

    function updateEditSubcategories(categoryId, preselectId = null) {
        const subcategorySelect = document.getElementById('editSubcategoryId');
        subcategorySelect.innerHTML = '<option value="">Select a subcategory</option>';

        if (categoryId) {
            fetch('/api/subcategories/' + categoryId)
                .then(response => response.json())
                .then(data => {
                    data.forEach(subcategory => {
                        const option = document.createElement('option');
                        option.value = subcategory.id;
                        option.textContent = subcategory.name;
                        subcategorySelect.appendChild(option);
                    });

                    // ✅ Preselect the given subcategory
                    if (preselectId) {
                        subcategorySelect.value = preselectId;
                    }
                })
                .catch(error => console.error('Error loading edit-subcategories:', error));
        }
    }

    function editTag(id, name, categoryId, subcategoryId) {
        document.getElementById('editTagForm').action = '/backend/tags/' + id + '/edit';
        document.getElementById('editName').value = name;
        document.getElementById('editCategoryId').value = categoryId;

        // Load subcategories and preselect current one
        updateEditSubcategories(categoryId, subcategoryId);
    }


</script>

{%endblock%}